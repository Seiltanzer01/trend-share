<!-- templates/subscription.html -->
{% extends "base.html" %}

{% block content %}
<div class="nes-container with-title">
  <p class="title">Стейкинг / Подписка</p>
  
  {% if not user.wallet_address %}
    <p>Сначала подключите кошелёк MetaMask:</p>
    <button class="nes-btn is-primary" id="connectWalletBtn">Connect Wallet (MetaMask)</button>
  {% else %}
    <p>Ваш кошелёк: <b>{{ user.wallet_address }}</b></p>
  {% endif %}
  
  <hr>
  <p>Чтобы получить/сохранить премиум, необходимо стейкать UJO на сумму эквивалент \> 20$.</p>
  <p>Адрес для отправки: <b>{{ MY_WALLET_ADDRESS }}</b></p>
  <p>Отправьте нужное кол-во UJO (например, 25$), из них 20$ фактически стейк, 5$ сбор. (В коде проверка ">=20$")</p>
  
  <div id="stakingArea" style="margin-top:1rem;"></div>
  
  <button class="nes-btn is-warning" id="claimRewardsBtn" style="display:none;">Claim Rewards</button>
  <button class="nes-btn is-error" id="unstakeBtn" style="display:none;">Unstake</button>
</div>

<script>
async function connectWallet() {
  if(window.ethereum) {
    try {
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      if(accounts && accounts.length>0) {
        const wallet = accounts[0];
        // отправим форму /set_wallet
        const formData = new FormData();
        formData.append('wallet_address', wallet);
        const resp = await fetch('/best_setup_voting/set_wallet', {
          method:'POST',
          body: formData
        });
        window.location.reload();
      }
    } catch(e) {
      alert('Ошибка при connectWallet: '+ e);
    }
  } else {
    alert('MetaMask не найден. Проверьте браузер/устройство.');
  }
}

async function loadStaking() {
  const resp = await fetch('/get_user_stakes');
  const data = await resp.json();
  if(data.error) {
    document.getElementById('stakingArea').innerHTML = '<p>'+data.error+'</p>';
    return;
  }
  const stakes = data.stakes;
  if(!stakes.length) {
    document.getElementById('stakingArea').innerHTML = '<p>У вас нет стейка.</p>';
    document.getElementById('claimRewardsBtn').style.display='none';
    document.getElementById('unstakeBtn').style.display='none';
    return;
  }
  let html = '';
  for(let s of stakes) {
    html += `
    <div class="nes-container is-rounded" style="margin-bottom:1rem;">
      <p>TX: ${s.tx_hash}</p>
      <p>Staked: ${s.staked_amount} UJO (~${s.staked_usd}$)</p>
      <p>Pending Rewards: ${s.pending_rewards} UJO</p>
      <p>Unlocked At: ${s.unlocked_at}</p>
    </div>
    `;
  }
  document.getElementById('stakingArea').innerHTML = html;
  document.getElementById('claimRewardsBtn').style.display='inline-block';
  document.getElementById('unstakeBtn').style.display='inline-block';
}

document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('connectWalletBtn');
  if(btn) btn.addEventListener('click', connectWallet);

  loadStaking();

  document.getElementById('claimRewardsBtn').addEventListener('click', async()=>{
    const resp = await fetch('/claim_staking_rewards', {method:'POST'});
    const data = await resp.json();
    if(data.error) alert(data.error);
    else {
      alert(data.message);
      loadStaking();
    }
  });

  document.getElementById('unstakeBtn').addEventListener('click', async()=>{
    const resp = await fetch('/unstake_staking',{method:'POST'});
    const data = await resp.json();
    if(data.error) alert(data.error);
    else {
      alert(data.message);
      loadStaking();
    }
  });
});
</script>
{% endblock %}
