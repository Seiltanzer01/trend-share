<!-- templates/subscription.html -->
{% extends "base.html" %}

{% block head_meta %}
<!-- Отключим глобальный viewport -->
{% endblock %}

{% block content %}
<div class="subscription-container">
    <h2>Подписка на Ассистента "Дядя Джон"</h2>
    <div class="nes-container is-rounded with-title">
        <p class="title">Преимущества подписки:</p>
        <ul>
            <li>Индивидуальный AI-ассистент анализа сделок</li>
            <li>Анализ загруженных графиков</li>
            <li>Персональные рекомендации</li>
            <li>Приоритетная поддержка</li>
        </ul>
        <p>
          Чтобы получить подписку, вам нужно отправить **25$** (в токенах UJO), 
          из них:
        </p>
        <ul>
          <li>20$ — пойдут в стейкинг, с которого будут начисляться награды.</li>
          <li>5$ — это сбор (fee), который не возвращается.</li>
        </ul>
        <p>
          Отправить эти 25$ (в UJO) вы можете прямо из мобильного Metamask 
          или другого EVM-совместимого кошелька. Получатель: 
          <b>{{ MY_WALLET_ADDRESS }}</b>.
        </p>
        
        <p>После подтверждения транзакции и её обнаружения в сети вам 
        будет автоматически включён премиум-доступ.</p>
        
        <hr>

        <h3>Ваши стейки:</h3>
        <div id="userStakesArea">
            <!-- сюда динамически подгрузим инфу о стейках -->
        </div>
        
        <p>
          <button class="nes-btn is-success" id="claimRewardsBtn">
            Получить награды (Claim)
          </button>
          <button class="nes-btn is-warning" id="unstakeBtn">
            Вывести из стейка (Unstake) 
          </button>
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Загрузим список стейков пользователя:
    fetch('/get_user_stakes')
      .then(r => r.json())
      .then(data => {
          if(data.error) {
              alert(data.error);
              return;
          }
          let container = document.getElementById('userStakesArea');
          container.innerHTML = '';
          data.stakes.forEach(st => {
              container.innerHTML += `
              <div class="nes-container is-rounded" style="margin-bottom:1rem;">
                  <p><b>Tx:</b> ${st.tx_hash}</p>
                  <p>Staked: ${st.staked_amount.toFixed(4)} UJO (~${st.staked_usd}$)</p>
                  <p>Fee: ${st.fee_amount.toFixed(4)} UJO (~${st.fee_usd}$)</p>
                  <p>UnlockedAt: ${st.unlocked_at}</p>
              </div>
              `;
          });
      });
    
    document.getElementById('claimRewardsBtn').addEventListener('click', () => {
        fetch('/claim_staking_rewards', {method:'POST'})
          .then(r => r.json())
          .then(data => {
              if(data.error) alert(data.error);
              else alert(data.message);
          })
          .catch(e => alert(e));
    });
    
    document.getElementById('unstakeBtn').addEventListener('click', () => {
        fetch('/unstake_staking', {method:'POST'})
          .then(r => r.json())
          .then(data => {
              if(data.error) alert(data.error);
              else alert(data.message);
          })
          .catch(e => alert(e));
    });
});
</script>
{% endblock %}
