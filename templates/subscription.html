<!-- templates/subscription.html -->
{% extends "base.html" %}

{% block content %}
<div class="nes-container with-title">
  <p class="title">Стейкинг / Подписка</p>
  
  {% if not user.wallet_address %}
    <p>Сначала подключите кошелёк MetaMask:</p>
    <button class="nes-btn is-primary" id="connectWalletBtn">Connect Wallet (MetaMask)</button>
  {% else %}
    <p>Ваш кошелёк: <b>{{ user.wallet_address }}</b></p>
  {% endif %}
  
  <hr>
  <p>Чтобы получить/сохранить премиум, необходимо внести UJO на сумму >= 20$ + 5$ сбор = 25$ (проверка >= 25$).</p>
  <p>Контракт будет проверять: <b>{{ MY_WALLET_ADDRESS }}</b> — адрес, куда вы отправляете.</p>
  <p>Нажмите кнопку «Застейкать (25$)» ниже, чтобы MetaMask сделал transfer.</p>
  
  {% if user.wallet_address %}
    <!-- Кнопка стейкинга с предзаполненной транзакцией через EIP-681 -->
    <a href="ethereum:{{ TOKEN_CONTRACT_ADDRESS }}/transfer?address={{ MY_WALLET_ADDRESS }}&uint256={{ (25 / token_price_usd) * (10 ** token_decimals)|int }}" class="nes-btn is-success">Застейкать (25$)</a>
  {% else %}
    <button class="nes-btn is-success" disabled>Застейкать (25$)</button>
  {% endif %}
  
  <div id="stakingArea" style="margin-top:1rem;"></div>
  
  <button class="nes-btn is-warning" id="claimRewardsBtn" style="display:none;">Claim Rewards</button>
  <button class="nes-btn is-error" id="unstakeBtn" style="display:none;">Unstake</button>
</div>

<!-- ethers.js CDN для других функций, если необходимо -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.umd.min.js"></script>
<script>
const TOKEN_CONTRACT_ADDRESS = "{{ TOKEN_CONTRACT_ADDRESS|default('0xYOUR_UJO_CONTRACT') }}"
const MY_WALLET_ADDRESS = "{{ MY_WALLET_ADDRESS|default('0xPROJECT') }}"
const TOKEN_DECIMALS = {{ TOKEN_DECIMALS|default(18) }}
const TOKEN_PRICE_USD = {{ token_price_usd|default(1.0) }}  // Предполагаемая переменная для цены токена

async function connectWallet() {
  if(window.ethereum) {
    try {
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' })
      if(accounts && accounts.length>0) {
        const wallet = accounts[0]
        const formData = new FormData()
        formData.append('wallet_address', wallet)
        const resp = await fetch('/best_setup_voting/set_wallet', {
          method: 'POST',
          body: formData
        })
        window.location.reload()
      }
    } catch(e) {
      alert('Ошибка при connectWallet: ' + e)
    }
  } else {
    alert('MetaMask не найден.')
  }
}

async function loadStaking() {
  const resp = await fetch('/staking/get_user_stakes')
  const data = await resp.json()
  if(data.error) {
    document.getElementById('stakingArea').innerHTML = '<p>'+data.error+'</p>'
    return
  }
  const stakes = data.stakes
  if(!stakes.length) {
    document.getElementById('stakingArea').innerHTML = '<p>У вас нет стейка.</p>'
    document.getElementById('claimRewardsBtn').style.display='none'
    document.getElementById('unstakeBtn').style.display='none'
    return
  }
  let html=''
  for(let s of stakes) {
    html += `<div class="nes-container is-rounded" style="margin-bottom:1rem;">
      <p><b>TX Hash:</b> ${s.tx_hash}</p>
      <p>Staked: ${s.staked_amount} UJO (~${s.staked_usd}$)</p>
      <p>Pending Rewards: ${s.pending_rewards} UJO</p>
      <p>Unlocked At: ${new Date(s.unlocked_at).toLocaleString()}</p>
    </div>`
  }
  document.getElementById('stakingArea').innerHTML = html
  document.getElementById('claimRewardsBtn').style.display='inline-block'
  document.getElementById('unstakeBtn').style.display='inline-block'
}

document.addEventListener('DOMContentLoaded', ()=> {
  const btnConn = document.getElementById('connectWalletBtn')
  if(btnConn) btnConn.addEventListener('click', connectWallet)

  loadStaking()

  document.getElementById('claimRewardsBtn').addEventListener('click', async()=> {
    const resp = await fetch('/staking/claim_staking_rewards',{method:'POST'})
    const data = await resp.json()
    if(data.error) alert(data.error)
    else {
      alert(data.message)
      loadStaking()
    }
  })

  document.getElementById('unstakeBtn').addEventListener('click', async()=>{
    const resp = await fetch('/staking/unstake_staking',{method:'POST'})
    const data = await resp.json()
    if(data.error) alert(data.error)
    else {
      alert(data.message)
      loadStaking()
    }
  })
})
</script>
{% endblock %}
