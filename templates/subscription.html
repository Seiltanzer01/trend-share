<!-- templates/subscription.html -->

{% extends "base.html" %}

{% block content %}
<div class="nes-container with-title">
  <p class="title">Стейкинг / Подписка</p>
  
  {% if not user.wallet_address %}
    <p>Сгенерируйте свой уникальный кошелёк для стейкинга:</p>
    <button class="nes-btn is-primary" id="generateWalletBtn">Сгенерировать Кошелёк</button>
  {% else %}
    <p>Ваш кошелёк: <b>{{ user.wallet_address }}</b></p>
    <button class="nes-btn is-success" id="copyWalletBtn"><i class="fas fa-copy"></i> Копировать Адрес</button>
    
    <hr>
    <h3>Ваши Балансы</h3>
    <ul>
      <li>ETH: <span id="ethBalance">Loading...</span></li>
      <li>WETH: <span id="wethBalance">Loading...</span></li>
      <li>UJO: <span id="ujoBalance">Loading...</span></li>
    </ul>
    
    <hr>
    <h3>Обмен Токенов</h3>
    <div class="exchange-container">
      <!-- Окно обмена 1 -->
      <div class="exchange-window nes-container is-rounded">
        <label for="fromToken">От:</label>
        <div class="nes-select">
          <select id="fromToken">
            <option value="ETH">ETH</option>
            <option value="WETH">WETH</option>
            <option value="UJO">UJO</option>
          </select>
        </div>
        <input type="number" id="fromAmount" class="nes-input" placeholder="Количество" min="0" step="0.0001" required>
      </div>
      
      <div class="exchange-arrow">
        <i class="fas fa-arrow-right fa-2x"></i>
      </div>
      
      <!-- Окно обмена 2 -->
      <div class="exchange-window nes-container is-rounded">
        <label for="toToken">В:</label>
        <div class="nes-select">
          <select id="toToken">
            <option value="WETH">WETH</option>
            <option value="UJO">UJO</option>
            <option value="ETH">ETH</option>
          </select>
        </div>
        <input type="text" id="toAmount" class="nes-input" placeholder="Количество" readonly>
      </div>
    </div>
    
    <button class="nes-btn is-primary" id="swapButton"><i class="fas fa-exchange-alt"></i> Обменять</button>
    
    <hr>
    <h3>Стейкинг</h3>
    <button class="nes-btn is-success" id="stakeButton">Застейкать (25$)</button>
    
    <div style="margin-top:1rem;">
      <h3>Подтвердите стейкинг</h3>
      <form id="confirmStakeForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="nes-field">
          <label for="tx_hash">Хэш транзакции:</label>
          <input type="text" id="tx_hash" name="txHash" class="nes-input" placeholder="0x..." required>
        </div>
        <button type="submit" class="nes-btn is-primary"><i class="fas fa-check"></i> Подтвердить Стейкинг</button>
      </form>
    </div>
    
    <div id="stakingArea" style="margin-top:1rem;"></div>
    
    <button class="nes-btn is-warning" id="claimRewardsBtn" style="display:none;">Claim Rewards</button>
    <button class="nes-btn is-error" id="unstakeBtn" style="display:none;">Unstake</button>
  {% endif %}
</div>

<!-- Модальное окно для изображений -->
<div id="modal" class="modal" style="display:none;">
  <span class="close">&times;</span>
  <img class="modal-content" id="modal-img">
</div>

<!-- Подключение необходимых библиотек -->
<!-- Web3.py не требуется на фронтенде, так как мы переходим на серверную логику -->

<!-- Подключение собственного скрипта -->
<script>
    window.config = {
        CSRF_TOKEN: "{{ csrf_token }}"
    };
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fromToken = document.getElementById('fromToken');
        const toToken = document.getElementById('toToken');
        const fromAmount = document.getElementById('fromAmount');
        const toAmount = document.getElementById('toAmount');
        const swapButton = document.getElementById('swapButton');

        // Пример фиксированных обменных курсов
        const exchangeRates = {
            'ETH': {'WETH': 1, 'UJO': 10},
            'WETH': {'ETH': 1, 'UJO': 10},
            'UJO': {'ETH': 0.1, 'WETH': 0.1}
        };

        function calculateToAmount() {
            const from = fromToken.value;
            const to = toToken.value;
            const amount = parseFloat(fromAmount.value);

            if (isNaN(amount) || amount <= 0) {
                toAmount.value = '';
                return;
            }

            if (exchangeRates[from] && exchangeRates[from][to]) {
                const rate = exchangeRates[from][to];
                toAmount.value = (amount * rate).toFixed(4);
            } else {
                toAmount.value = '0.0000';
            }
        }

        fromToken.addEventListener('change', calculateToAmount);
        toToken.addEventListener('change', calculateToAmount);
        fromAmount.addEventListener('input', calculateToAmount);

        swapButton.addEventListener('click', (e) => {
            e.preventDefault();
            const from = fromToken.value;
            const to = toToken.value;
            const amount = parseFloat(fromAmount.value);

            if (isNaN(amount) || amount <= 0) {
                alert('Введите корректное количество для обмена.');
                return;
            }

            // Отправка запроса на сервер для выполнения обмена
            fetch('/staking/api/exchange', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.config.CSRF_TOKEN
                },
                body: JSON.stringify({
                    from_token: from,
                    to_token: to,
                    amount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Успешно обменяно ${amount} ${from} на ${data.received} ${to}.`);
                    // Обновление балансов
                    updateBalances();
                } else {
                    alert(`Ошибка обмена: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при обмене.');
            });
        });

        function updateBalances() {
            fetch('/staking/api/get_balances?user_id={{ user.id }}')
            .then(response => response.json())
            .then(data => {
                if (data.eth_balance) {
                    document.getElementById('ethBalance').innerText = data.eth_balance;
                }
                if (data.weth_balance) {
                    document.getElementById('wethBalance').innerText = data.weth_balance;
                }
                if (data.ujo_balance) {
                    document.getElementById('ujoBalance').innerText = data.ujo_balance;
                }
            })
            .catch(error => {
                console.error('Ошибка обновления балансов:', error);
            });
        }

        // Инициализация балансов при загрузке страницы
        updateBalances();
    });
</script>
{% endblock %}
