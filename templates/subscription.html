<!-- templates/subscription.html -->
{% extends "base.html" %}

{% block head_meta %}
<!-- Отключим глобальный viewport -->
{% endblock %}

{% block content %}
<div class="subscription-container">
    <h2>Подписка на Ассистента "Дядя Джон"</h2>
    <div class="nes-container is-rounded with-title">
        <p class="title">Преимущества подписки:</p>
        <ul>
            <li>Индивидуальный AI-ассистент анализа сделок</li>
            <li>Анализ загруженных графиков</li>
            <li>Персональные рекомендации</li>
            <li>Приоритетная поддержка</li>
        </ul>
        <p>Чтобы получить подписку, вы должны отправить минимум $25 в токене (например 20$ «стейка» и 5$ сбор).
           <br>
           <strong>Отправляйте токены на адрес: <span style="color: red">{{ MY_WALLET_ADDRESS }}</span></strong>
        </p>
        
        <button class="nes-btn is-primary" id="stake20-btn">
            <i class="fas fa-coins"></i> Застейкать (минимум 25$)
        </button>
        
        <button class="nes-btn is-warning" id="unstake-btn">
            <i class="fas fa-hand-holding-usd"></i> Вывести Стейк (после 30 дней)
        </button>
        
        <p>После стейка вам будет автоматически включён премиум, пока ваш стейк активен.</p>
        
        <p>Для удобства на мобильных кошельках можно использовать <strong>WalletConnect</strong> или <strong>MetaMask Deeplink</strong>:
        <br><a href="#" class="nes-btn is-success" id="openMetamaskLink">Открыть MetaMask</a></p>
    </div>
</div>

<footer>
    <div class="footer-links">
        <a href="{{ url_for('privacy_policy') }}" class="nes-btn">Публичная оферта</a>
        <a href="{{ url_for('additional_info') }}" class="nes-btn">Доп. информация</a>
    </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // При нажатии "Застейкать"
    document.getElementById('stake20-btn').addEventListener('click', async() => {
        try {
            // POST /stake
            const resp = await fetch('/stake', {
                method: 'POST'
            });
            if(resp.redirected) {
                window.location.href = resp.url;
            } else {
                const text = await resp.text();
                console.log(text);
                // можно показать flash
                window.location.reload();
            }
        } catch(e) {
            alert('Ошибка stake: ' + e);
        }
    });

    // При нажатии "Вывести Стейк"
    document.getElementById('unstake-btn').addEventListener('click', async() => {
        try {
            const resp = await fetch('/unstake', {
                method: 'POST'
            });
            if(resp.redirected) {
                window.location.href = resp.url;
            } else {
                const text = await resp.text();
                console.log(text);
                window.location.reload();
            }
        } catch(e) {
            alert('Ошибка unstake: ' + e);
        }
    });

    document.getElementById('openMetamaskLink').addEventListener('click', (e) => {
        e.preventDefault();
        // например deeplink для MetaMask: 
        // (но это очень зависит от платформы)
        let metamaskDeeplink = "metamask://";
        window.location.href = metamaskDeeplink;
    });
});
</script>
{% endblock %}
