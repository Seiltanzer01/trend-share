<!-- templates/subscription.html -->
{% extends "base.html" %}

{% block content %}
<div class="nes-container with-title">
  <p class="title">Стейкинг / Подписка</p>
  
  {% if not user.wallet_address %}
    <p>Сначала подключите кошелёк:</p>
    <button class="nes-btn is-primary" id="connectWalletBtn">Connect Wallet</button>
    <div id="walletOptions" style="margin-top: 1rem; display: none;">
      <button class="nes-btn is-warning" id="connectMetaMask">Connect with MetaMask</button>
      <button class="nes-btn is-success" id="connectWalletConnect">Connect with WalletConnect</button>
    </div>
  {% else %}
    <p>Ваш кошелёк: <b>{{ user.wallet_address }}</b></p>
  {% endif %}
  
  <hr>
  <p>Чтобы получить/сохранить премиум, необходимо внести UJO на сумму >= 20$ + 5$ сбор = 25$ (проверка >= 25$).</p>
  <p>Контракт будет проверять: <b>{{ MY_WALLET_ADDRESS }}</b> — адрес, куда вы отправляете.</p>
  
  {% if user.wallet_address %}
    <!-- Кнопка стейкинга -->
    {% set amount_usd = 25 %}
    {% set token_amount = (amount_usd / token_price_usd) %}
    {% set token_amount_wei = (token_amount * (10 ** TOKEN_DECIMALS))|int %}
    <button class="nes-btn is-success" id="stakeButton">Застейкать ({{ amount_usd }}$)</button>
    
    <!-- Форма для подтверждения стейкинга -->
    <div style="margin-top:1rem;">
      <h3>Подтвердите стейкинг</h3>
      <form id="confirmStakeForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="nes-field">
          <label for="tx_hash">Хэш транзакции:</label>
          <input type="text" id="tx_hash" name="txHash" class="nes-input" placeholder="0x..." required>
        </div>
        <button type="submit" class="nes-btn is-primary"><i class="fas fa-check"></i> Подтвердить Стейкинг</button>
      </form>
    </div>
  {% else %}
    <button class="nes-btn is-success" disabled>Застейкать (25$)</button>
  {% endif %}
  
  <div id="stakingArea" style="margin-top:1rem;"></div>
  
  <button class="nes-btn is-warning" id="claimRewardsBtn" style="display:none;">Claim Rewards</button>
  <button class="nes-btn is-error" id="unstakeBtn" style="display:none;">Unstake</button>
</div>

<!-- Подключение необходимых библиотек -->
<!-- Web3.js -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
<!-- WalletConnect Provider -->
<script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
<!-- Подключение собственного скрипта -->
<script src="{{ url_for('static', filename='scripts.js') }}"></script>
{% endblock %}
