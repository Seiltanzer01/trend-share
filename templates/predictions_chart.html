<!-- templates/predictions_chart.html -->

{% extends "base.html" %}

{% block content %}
<h1>Диаграммы Предсказаний</h1>

{% if charts %}
    {% for instrument, image in charts.items() %}
        <div class="nes-container with-title">
            <p class="title">{{ instrument }}</p>
            <img id="chart-{{ loop.index }}" src="data:image/png;base64,{{ image }}" alt="Диаграмма предсказаний для {{ instrument.split(' (')[0] }}" class="responsive-chart">
            <p class="update-time">Последнее обновление: {{ datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC') }}</p>
            <div id="loader-{{ loop.index }}" class="loader" style="display: none;"></div>
        </div>
        <br>
    {% endfor %}
{% else %}
    <p>Нет доступных диаграмм для отображения.</p>
{% endif %}

<!-- Добавляем стили для индикатора загрузки -->
<style>
    .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 10px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .responsive-chart {
        max-width: 100%;
        height: auto;
    }
</style>

<!-- Добавляем скрипт для обновления диаграмм -->
<script>
    function fetchCharts() {
        fetch("{{ url_for('fetch_charts') }}")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                const charts = data.charts;
                for (const [instrument, image] of Object.entries(charts)) {
                    // Находим соответствующий элемент по имени инструмента
                    const chartElement = document.querySelector(`img[alt="Диаграмма предсказаний для ${instrument.split(' (')[0]}"]`);
                    if (chartElement) {
                        // Показать индикатор загрузки
                        const loaderId = `loader-${Array.from(document.querySelectorAll('img')).indexOf(chartElement) + 1}`;
                        const loaderElement = document.getElementById(loaderId);
                        if (loaderElement) loaderElement.style.display = 'block';

                        // Обновляем изображение
                        chartElement.src = `data:image/png;base64,${image}`;
                        // Обновляем время последнего обновления
                        const updateTimeElement = chartElement.parentElement.querySelector('.update-time');
                        if (updateTimeElement) {
                            const now = new Date();
                            const utcString = now.toISOString().slice(0, 19).replace('T', ' ');
                            updateTimeElement.textContent = `Последнее обновление: ${utcString} UTC`;
                        }

                        // Скрыть индикатор загрузки после обновления
                        if (loaderElement) loaderElement.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching charts:', error);
                // Скрыть индикаторы загрузки при ошибке
                document.querySelectorAll('.loader').forEach(loader => loader.style.display = 'none');
            });
    }

    // Обновляем диаграммы каждые 30 секунд
    setInterval(fetchCharts, 30000);

    // Вызовем функцию при загрузке страницы
    window.onload = fetchCharts;
</script>
{% endblock %}
